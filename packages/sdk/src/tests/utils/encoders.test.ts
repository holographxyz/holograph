import {Hex} from 'viem'
import {describe, expect, it} from 'vitest'

import {create2address, getERC721DeploymentConfigHash, storageSlot} from '../../utils/encoders'
import {DeploymentConfigSettings} from '../../utils/types'

describe('Utils: encoders', () => {
  const deploymentConfig: DeploymentConfigSettings = {
    config: {
      contractType: '0x0000000000000000000000000000000000486f6c6f6772617068455243373231',
      chainType: 4000000011,
      salt: '0x00000000000000000000000000000000000000000000000000000189d9ce903f',
      byteCode:
        '0x608060405234801561001057600080fd5b50610b32806100206000396000f3fe6080604052600436106100695760003560e01c8063704b6c0211610043578063704b6c0214610166578063bf64a82d14610186578063f851a4401461019957610070565b806342809873146100a25780634ddf47d4146100e15780636e9960c31461013257610070565b3661007057005b600061007a6101ae565b90503660008037600080366000845af43d6000803e80801561009b573d6000f35b3d6000fd5b005b3480156100ae57600080fd5b506100b76101ae565b60405173ffffffffffffffffffffffffffffffffffffffff90911681526020015b60405180910390f35b3480156100ed57600080fd5b506101016100fc366004610845565b61028d565b6040517fffffffff0000000000000000000000000000000000000000000000000000000090911681526020016100d8565b34801561013e57600080fd5b507f3f106594dc74eeef980dae234cde8324dc2497b13d27a0c59e55bd2ca10a07c9546100b7565b34801561017257600080fd5b506100a06101813660046108ea565b6105a2565b6100a061019436600461090e565b61067c565b3480156101a557600080fd5b506100b7610752565b7fce8e75d5c5227ce29a4ee170160bb296e5dea6934b80a9bd723f7ef1e7c850e7547f0b671eb65810897366dd82c4cbb7d9dff8beda8484194956e81e89b8a361d9c7546040517fcc2913f900000000000000000000000000000000000000000000000000000000815260048101829052600092919073ffffffffffffffffffffffffffffffffffffffff83169063cc2913f990602401602060405180830381865afa158015610262573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906102869190610993565b9250505090565b60006102b77f4e5f991bca30eca2d4643aaefa807e88f96a4a97398933d572a3c0d973004a015490565b15610323576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601e60248201527f484f4c4f47524150483a20616c726561647920696e697469616c697a6564000060448201526064015b60405180910390fd5b60008060008480602001905181019061033c91906109e0565b925092509250827f0b671eb65810897366dd82c4cbb7d9dff8beda8484194956e81e89b8a361d9c755817fce8e75d5c5227ce29a4ee170160bb296e5dea6934b80a9bd723f7ef1e7c850e7556000806103936101ae565b73ffffffffffffffffffffffffffffffffffffffff16836040516024016103ba9190610a76565b604080517fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08184030181529181526020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff167f4ddf47d4000000000000000000000000000000000000000000000000000000001790525161043b9190610ac7565b600060405180830381855af49150503d8060008114610476576040519150601f19603f3d011682016040523d82523d6000602084013e61047b565b606091505b50915091506000818060200190518101906104969190610ae3565b90508280156104e657507fffffffff0000000000000000000000000000000000000000000000000000000081167f4ddf47d400000000000000000000000000000000000000000000000000000000145b61054c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601560248201527f696e697469616c697a6174696f6e206661696c65640000000000000000000000604482015260640161031a565b61057560017f4e5f991bca30eca2d4643aaefa807e88f96a4a97398933d572a3c0d973004a0155565b507f4ddf47d400000000000000000000000000000000000000000000000000000000979650505050505050565b7f3f106594dc74eeef980dae234cde8324dc2497b13d27a0c59e55bd2ca10a07c95473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610658576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601e60248201527f484f4c4f47524150483a2061646d696e206f6e6c792066756e6374696f6e0000604482015260640161031a565b7f3f106594dc74eeef980dae234cde8324dc2497b13d27a0c59e55bd2ca10a07c955565b7f3f106594dc74eeef980dae234cde8324dc2497b13d27a0c59e55bd2ca10a07c95473ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610732576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601e60248201527f484f4c4f47524150483a2061646d696e206f6e6c792066756e6374696f6e0000604482015260640161031a565b808260003760008082600034875af13d6000803e80801561009b573d6000f35b600061077c7f3f106594dc74eeef980dae234cde8324dc2497b13d27a0c59e55bd2ca10a07c95490565b905090565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051601f82017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe016810167ffffffffffffffff811182821017156107f7576107f7610781565b604052919050565b600067ffffffffffffffff82111561081957610819610781565b50601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01660200190565b60006020828403121561085757600080fd5b813567ffffffffffffffff81111561086e57600080fd5b8201601f8101841361087f57600080fd5b803561089261088d826107ff565b6107b0565b8181528560208385010111156108a757600080fd5b81602084016020830137600091810160200191909152949350505050565b73ffffffffffffffffffffffffffffffffffffffff811681146108e757600080fd5b50565b6000602082840312156108fc57600080fd5b8135610907816108c5565b9392505050565b60008060006040848603121561092357600080fd5b833561092e816108c5565b9250602084013567ffffffffffffffff8082111561094b57600080fd5b818601915086601f83011261095f57600080fd5b81358181111561096e57600080fd5b87602082850101111561098057600080fd5b6020830194508093505050509250925092565b6000602082840312156109a557600080fd5b8151610907816108c5565b60005b838110156109cb5781810151838201526020016109b3565b838111156109da576000848401525b50505050565b6000806000606084860312156109f557600080fd5b835192506020840151610a07816108c5565b604085015190925067ffffffffffffffff811115610a2457600080fd5b8401601f81018613610a3557600080fd5b8051610a4361088d826107ff565b818152876020838501011115610a5857600080fd5b610a698260208301602086016109b0565b8093505050509250925092565b6020815260008251806020840152610a958160408501602087016109b0565b601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169190910160400192915050565b60008251610ad98184602087016109b0565b9190910192915050565b600060208284031215610af557600080fd5b81517fffffffff000000000000000000000000000000000000000000000000000000008116811461090757600080fdfea164736f6c634300080d000a',
      initCode:
        '0x00000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000140000000000000000000000000000000000000000000000000000000000000000653696d706c650000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000353494d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000043786970455243373231000000000000000000000000ae27815bcf7cca7191cb55a6b86576aedc462bbb00000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000020000000000000000000000000b2613e02f232d00bcf060c2c70a9b60d0930959a',
    },
    signature: {
      r: '0x85ae2a5b379eadf2b3d52f9088d8b5d1328d6a6ee6b8bead9666a9946349adcf',
      s: '0x37f970dc45104116ae651827d313ee66a797b17d44e0d6e78b2b68d6795ef849',
      v: 28,
    },
    signer: '0xb2613e02f232d00bcf060c2c70a9b60d0930959a',
  }

  it('create2address', () => {
    const factoryAddress = '0x90425798cc0e33932f11edc3eedbd4f3f88dff64'
    const expectedValue = '0xa7207112f4bfec450ace2a40b5ba7835c225c2a9'
    const contractAddress = create2address(deploymentConfig, factoryAddress)

    expect(contractAddress).toBe(expectedValue)
  })

  it('deploymentConfigHash', () => {
    const expectedValue = '0x4875df98a47bb96390261e59aadcc40580f8a2e98390bec380cffd60c6c61178'
    const value = getERC721DeploymentConfigHash(deploymentConfig.config, deploymentConfig.signer)

    expect(value).toBe(expectedValue)
  })

  it('storageSlot', () => {
    const expectedValue = '0x0b671eb65810897366dd82c4cbb7d9dff8beda8484194956e81e89b8a361d9c7'
    const input = 'eip1967.Holograph.contractType'
    const value = storageSlot(input as Hex)

    expect(value).toBe(expectedValue)
  })
})
